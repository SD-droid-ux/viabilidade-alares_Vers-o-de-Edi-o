[phases.setup]
nixPkgs = ["nodejs_18", "npm-9_x"]

[variables]
NODE_ENV = "production"

[phases.install]
cmds = [
  # Otimizar configuração do npm para builds mais rápidos
  "npm config set fetch-retries 2",
  "npm config set fetch-retry-mintimeout 20000",
  "npm config set fetch-retry-maxtimeout 120000",
  "npm config set progress false",
  "npm config set loglevel error",
  # Instalar com cache otimizado
  "npm ci --prefer-offline --no-audit --legacy-peer-deps --silent || npm install --prefer-offline --no-audit --legacy-peer-deps --silent"
]

[phases.build]
cmds = [
  # Limpar cache antes do build para garantir build limpo
  "rm -rf .vite dist 2>/dev/null || true",
  "NODE_ENV=production npm run build"
]

[start]
cmd = "npm start"

